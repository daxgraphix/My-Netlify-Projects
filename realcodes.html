<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Smart Hero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-color: #38bdf8;
            --accent-color-dark: #0ea5e9;
        }
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #020617, #111827, #312e81);
            color: #e2e8f0;
        }
        .light .gradient-bg {
             background: linear-gradient(135deg, #e0f2fe, #dbeafe, #c7d2fe);
             color: #1e293b;
        }

        #grid-pattern {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(255, 255, 255, 0.07) 1px, transparent 1px), linear-gradient(to right, rgba(255, 255, 255, 0.07) 1px, transparent 1px);
            background-size: 3rem 3rem;
            animation: grid-scroll 60s linear infinite;
            z-index: -2;
        }
        .light #grid-pattern {
             background-image: linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px), linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
        }
        @keyframes grid-scroll {
            from { background-position: 0 0; }
            to { background-position: -3rem -3rem; }
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .modal-enter { animation: modal-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .modal-exit { animation: modal-out 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards; }
        @keyframes modal-in { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes modal-out { from { opacity: 1; transform: scale(1) translateY(0); } to { opacity: 0; transform: scale(0.9) translateY(20px); } }
        
        .btn-press:active { transform: scale(0.95); }
        button:disabled {
            background-color: #4b5563 !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .avatar-option { transition: all 0.2s ease; cursor: pointer; border: 4px solid transparent; }
        .avatar-option:hover { border-color: var(--accent-color); }
        .avatar-option.selected { border-color: #22c55e; transform: scale(1.1); box-shadow: 0 0 15px rgba(34, 197, 94, 0.7); }

        .color-swatch {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 4px solid transparent;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
            border-color: white;
            box-shadow: 0 0 10px white;
        }
        .light .color-swatch.selected { border-color: #020617; box-shadow: 0 0 10px #020617; }
        
        .glowing-title { animation: glow 2.5s ease-in-out infinite alternate; }
        @keyframes glow { 
            from { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--accent-color), 0 0 20px var(--accent-color); } 
            to { text-shadow: 0 0 10px #fff, 0 0 15px #fff, 0 0 20px var(--accent-color-dark), 0 0 25px var(--accent-color-dark); } 
        }

        #mobile-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #mobile-sidebar.open {
            transform: translateX(0);
        }
        #sidebar-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .toast {
            animation: toast-in 0.5s ease, toast-out 0.5s ease 2.5s forwards;
        }
        @keyframes toast-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }

        .screen {
            transition: opacity 0.5s, transform 0.5s;
        }
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
        }
        
        .mission-card { transition: all 0.3s ease; }
        .mission-card:hover { transform: translateY(-8px); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .mission-card.glitchy { filter: grayscale(1) contrast(3); opacity: 0.6; animation: glitch-anim 3s infinite; }
        @keyframes glitch-anim { 0%, 100% { transform: translate(0, 0); } 20% { transform: translate(-3px, 3px); } 40% { transform: translate(3px, -3px); } 60% { transform: translate(-3px, -3px); } 80% { transform: translate(3px, 3px); } }
        .mission-card.completed { animation: none; filter: none; opacity: 1; }
        .mission-card.hero-completed { box-shadow: 0 0 20px #f59e0b; }
        
        .phishing-drop-zone {
            transition: all 0.2s ease;
        }
        .phishing-drop-zone.over {
            background-color: rgba(56, 189, 248, 0.3);
            border-color: var(--accent-color);
        }
        .phishing-drop-zone.correct {
            border-color: #22c55e;
            background-color: rgba(34, 197, 94, 0.2);
        }
    </style>
</head>
<body class="gradient-bg text-slate-200">
    <div id="grid-pattern"></div>
    <div id="app" class="min-h-screen p-0 flex flex-col items-center justify-center transition-opacity duration-500 relative w-full h-full">
        
        <!-- Screens -->
        <div id="splash-screen" class="screen flex absolute inset-0 text-center flex-col items-center justify-center p-8 bg-slate-900/50 backdrop-blur-sm">
            <h1 class="text-4xl sm:text-6xl font-bold bg-gradient-to-r from-sky-400 to-cyan-300 text-transparent bg-clip-text mb-4 glowing-title">Cyber Smart Hero</h1>
            <p class="mt-4 max-w-2xl text-slate-300 text-lg sm:text-xl">An interactive adventure to master the world of online safety.</p>
            <button id="start-journey-btn" class="mt-12 bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 px-10 rounded-full text-2xl transition duration-300 transform hover:scale-105 btn-press shadow-lg shadow-sky-500/30">Start Your Journey</button>
        </div>

        <div id="login-screen" class="screen hidden absolute inset-0 text-center flex-col items-center justify-center p-8">
            <div class="p-8 bg-slate-900/50 backdrop-blur-sm rounded-2xl border border-slate-700">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-100 mb-4">Who is the Hero?</h1>
                <input type="text" id="username-input" class="mt-6 w-full max-w-xs p-3 bg-slate-700 border-2 border-slate-600 rounded-lg text-white text-center text-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none">
                <button id="play-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-xl transition duration-300 transform btn-press">Next</button>
            </div>
        </div>

        <div id="avatar-screen" class="screen hidden absolute inset-0 text-center flex-col items-center justify-center p-8">
            <div class="p-8 bg-slate-900/50 backdrop-blur-sm rounded-2xl border border-slate-700 w-full max-w-4xl">
                 <h1 class="text-3xl sm:text-4xl font-bold text-slate-100">Design Your Hero</h1>
                 <div class="grid md:grid-cols-2 gap-8 mt-8 items-center">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 bg-gradient-to-r from-purple-400 to-pink-400 text-transparent bg-clip-text">Choose an Avatar</h2>
                        <div id="avatar-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-semibold mb-4 bg-gradient-to-r from-purple-400 to-pink-400 text-transparent bg-clip-text">Choose a Color</h2>
                        <div id="color-grid" class="grid grid-cols-3 sm:grid-cols-5 gap-4 justify-center"></div>
                    </div>
                 </div>
                 <div class="flex items-center justify-center gap-4 mt-8">
                    <button id="back-to-login-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full text-xl transition duration-300 transform btn-press">Back</button>
                    <button id="confirm-avatar-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl transition duration-300 transform btn-press">Next</button>
                </div>
            </div>
        </div>

        <div id="welcome-screen" class="screen hidden absolute inset-0 text-center flex-col items-center justify-center p-8">
             <div id="welcome-avatar" class="mb-4"></div>
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-slate-100">Welcome, <span id="welcome-username" class="font-bold"></span>!</h1>
            <p class="mt-4 max-w-xl text-slate-300 text-base sm:text-lg">This is your personalized Hero. Ready to protect Cyber City?</p>
            <div class="flex items-center gap-4 mt-8">
                <button id="back-to-avatar-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-full text-xl transition duration-300 transform btn-press">Go Back</button>
                <button id="start-adventure-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-xl transition duration-300 transform btn-press">Start Adventure</button>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="screen hidden w-full max-w-full lg:grid lg:grid-cols-[250px_1fr] h-screen gap-6">
            <!-- Sidebar -->
            <aside class="hidden lg:flex flex-col bg-slate-900/50 backdrop-blur-sm rounded-2xl border border-slate-700 p-6">
                <h2 class="text-2xl font-bold mb-6 text-center bg-gradient-to-r from-sky-400 to-cyan-300 text-transparent bg-clip-text">Hero Menu</h2>
                <nav class="flex flex-col gap-4">
                    <button id="hq-btn" aria-label="Guardian HQ" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                        <span>Guardian HQ</span>
                    </button>
                    <button id="handbook-btn" aria-label="Handbook" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <span>Handbook</span>
                    </button>
                     <button id="story-btn" aria-label="Story Missions" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                        <span>Story Missions</span>
                    </button>
                </nav>
                <div class="mt-auto">
                    <button id="theme-toggle-btn" aria-label="Toggle Theme" class="flex items-center gap-3 p-3 w-full rounded-lg hover:bg-slate-700/50 transition-colors"></button>
                    <button id="sound-toggle-btn" aria-label="Toggle Sound" class="flex items-center gap-3 p-3 w-full rounded-lg hover:bg-slate-700/50 transition-colors"></button>
                    <button id="reset-btn" aria-label="Reset Progress" class="flex items-center gap-3 p-3 w-full text-red-400 rounded-lg hover:bg-red-500/10 transition-colors mt-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                        <span>Reset Progress</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="flex flex-col h-screen">
                <header class="text-center py-4 flex-shrink-0 flex justify-center items-center gap-4 relative">
                    <button id="menu-btn-mobile" aria-label="Open Menu" class="absolute left-4 top-1/2 -translate-y-1/2 p-2 bg-slate-700/50 rounded-full hover:bg-slate-600/50 transition-colors lg:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-sky-400 to-cyan-300 text-transparent bg-clip-text glowing-title">Cyber City</h1>
                </header>
                
                <main class="w-full flex-grow flex flex-col justify-center overflow-hidden">
                    <div id="stats-bar" class="mb-8 p-4 bg-slate-900/50 backdrop-blur-sm rounded-xl flex flex-col sm:flex-row justify-around items-center gap-4 border border-slate-700 w-full max-w-5xl mx-auto">
                        <div class="flex items-center gap-3">
                            <div id="dashboard-avatar" class="w-12 h-12 bg-slate-700 rounded-full p-1 transition-transform hover:scale-110 relative overflow-hidden"></div>
                            <span id="dashboard-username" class="font-bold text-xl text-slate-200"></span>
                        </div>
                        <div class="text-center relative group">
                            <div class="text-sky-400 font-bold text-2xl" id="total-points-stat">0</div>
                            <div class="text-sm text-slate-400">Total Points</div>
                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block px-2 py-1 bg-slate-800 text-xs rounded-md">Spend these in the Guardian HQ!</div>
                        </div>
                        <div class="text-center">
                            <div class="text-amber-400 font-bold text-2xl" id="badges-earned-stat">0/5</div>
                            <div class="text-sm text-slate-400">Badges Earned</div>
                        </div>
                        <div class="w-full sm:w-1/4">
                            <div class="text-center text-sm text-slate-400 mb-1">Mission Progress</div>
                            <div class="w-full bg-slate-700 rounded-full h-2.5"><div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                    </div>
                    <div id="adventure-path-wrapper" class="w-full relative">
                        <div id="adventure-path-container" class="w-full"></div>
                    </div>
                </main>
                
                <footer class="text-center py-4 text-slate-400 text-sm flex-shrink-0">
                    <p>Cyber Smart Hero © 2025. Stay safe, stay awesome!</p>
                </footer>
            </div>
        </div>
        
        <div id="certificate-screen" class="hidden text-center flex-col items-center bg-slate-900/80 backdrop-blur-sm p-8 rounded-2xl border-4 border-amber-400 shadow-2xl shadow-amber-500/20">
            <h1 class="text-3xl sm:text-4xl font-bold text-amber-300">Congratulations!</h1>
            <p class="text-lg sm:text-xl text-slate-200 mt-2">You've completed your training and earned the rank of</p>
            <h2 class="text-4xl sm:text-5xl font-bold my-4 bg-gradient-to-r from-amber-300 to-amber-500 text-transparent bg-clip-text">Cyber Hero!</h2>
            <div id="certificate-avatar" class="my-4 border-4 border-amber-300 rounded-full p-1"></div>
            <div id="certificate-username" class="text-2xl sm:text-3xl font-bold"></div>
            <p class="mt-6 text-slate-300">You have earned all the badges and proven your skills!</p>
            <div id="certificate-badges" class="flex gap-4 mt-4"></div>
            <button id="play-again-btn" class="mt-8 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-xl transition duration-300 transform hover:scale-105 btn-press">Play Again</button>
        </div>

    </div>

    <!-- Mobile Sidebar -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/50 z-30 opacity-0 pointer-events-none lg:hidden"></div>
    <aside id="mobile-sidebar" class="fixed top-0 left-0 h-full w-64 bg-slate-900 border-r border-slate-700 p-6 z-40 lg:hidden">
        <h2 class="text-2xl font-bold mb-6 text-center bg-gradient-to-r from-sky-400 to-cyan-300 text-transparent bg-clip-text">Hero Menu</h2>
        <nav class="flex flex-col gap-4">
            <button id="hq-btn-mobile" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <span>Guardian HQ</span>
            </button>
            <button id="handbook-btn-mobile" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-400"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                <span>Handbook</span>
            </button>
            <button id="story-btn-mobile" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700/50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                <span>Story Missions</span>
            </button>
        </nav>
        <div class="mt-auto absolute bottom-6 left-6 right-6">
            <button id="theme-toggle-btn-mobile" class="flex items-center gap-3 p-3 w-full rounded-lg hover:bg-slate-700/50 transition-colors"></button>
            <button id="sound-toggle-btn-mobile" class="flex items-center gap-3 p-3 w-full rounded-lg hover:bg-slate-700/50 transition-colors"></button>
            <button id="reset-btn-mobile" class="flex items-center gap-3 p-3 w-full text-red-400 rounded-lg hover:bg-red-500/10 transition-colors mt-2">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                <span>Reset Progress</span>
            </button>
        </div>
    </aside>


    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="modal-enter bg-slate-800 rounded-2xl w-11/12 max-w-3xl max-h-[90vh] flex flex-col shadow-2xl border border-slate-700">
            <header id="modal-header" class="p-5 border-b border-slate-700 flex justify-between items-center modal-header-default rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div id="modal-header-icon" class="w-8 h-8"></div>
                    <h3 id="modal-title" class="text-xl sm:text-2xl font-bold text-white">Module Title</h3>
                </div>
                <div id="timer-display" class="hidden text-xl sm:text-2xl font-bold"></div>
                <button id="close-modal-btn" class="text-slate-300 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </header>
            <main id="modal-body" class="p-6 overflow-y-auto"></main>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENTS (added new ones) ---
        const app = document.getElementById('app');
        const loginScreen = document.getElementById('login-screen');
        const usernameInput = document.getElementById('username-input');
        const playBtn = document.getElementById('play-btn');
        const avatarScreen = document.getElementById('avatar-screen');
        const avatarGrid = document.getElementById('avatar-grid');
        const colorGrid = document.getElementById('color-grid');
        const confirmAvatarBtn = document.getElementById('confirm-avatar-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        const welcomeScreen = document.getElementById('welcome-screen');
        const welcomeAvatar = document.getElementById('welcome-avatar');
        const welcomeUsername = document.getElementById('welcome-username');
        const dashboard = document.getElementById('dashboard');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const hqBtn = document.getElementById('hq-btn');
        const handbookBtn = document.getElementById('handbook-btn');
        const resetBtn = document.getElementById('reset-btn');
        const storyBtn = document.getElementById('story-btn');
        const menuBtnMobile = document.getElementById('menu-btn-mobile');
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        const soundToggleBtnMobile = document.getElementById('sound-toggle-btn-mobile');
        const themeToggleBtnMobile = document.getElementById('theme-toggle-btn-mobile');
        const hqBtnMobile = document.getElementById('hq-btn-mobile');
        const handbookBtnMobile = document.getElementById('handbook-btn-mobile');
        const storyBtnMobile = document.getElementById('story-btn-mobile');
        const resetBtnMobile = document.getElementById('reset-btn-mobile');
        const toastContainer = document.getElementById('toast-container');

        const statsBar = {
            avatar: document.getElementById('dashboard-avatar'), username: document.getElementById('dashboard-username'),
            points: document.getElementById('total-points-stat'), badges: document.getElementById('badges-earned-stat'),
            progress: document.getElementById('progress-bar')
        };
        const splashScreen = document.getElementById('splash-screen');
        const startJourneyBtn = document.getElementById('start-journey-btn');
        const backToAvatarBtn = document.getElementById('back-to-avatar-btn');
        const startAdventureBtn = document.getElementById('start-adventure-btn');
        const adventurePathWrapper = document.getElementById('adventure-path-wrapper');
        const adventurePathContainer = document.getElementById('adventure-path-container');
        const certificateScreen = document.getElementById('certificate-screen');
        const certificateAvatar = document.getElementById('certificate-avatar');
        const certificateUsername = document.getElementById('certificate-username');
        const certificateBadges = document.getElementById('certificate-badges');
        const playAgainBtn = document.getElementById('play-again-btn');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const modalHeader = document.getElementById('modal-header');
        const modalTitle = document.getElementById('modal-title');
        const modalHeaderIcon = document.getElementById('modal-header-icon');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const timerDisplay = document.getElementById('timer-display');

        // --- GAME DATA (added heroContent and stories) ---
        const avatars = [ { id: 'bot1', svg: '<svg width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C9.23858 2 7 4.23858 7 7V11C7 11.5523 7.44772 12 8 12H16C16.5523 12 17 11.5523 17 11V7C17 4.23858 14.7614 2 12 2Z" class="avatar-colorable" fill="#38bdf8"/><path d="M6 14C6 13.4477 6.44772 13 7 13H17C17.5523 13 18 13.4477 18 14V17C18 19.2091 16.2091 21 14 21H10C7.79086 21 6 19.2091 6 17V14Z" fill="#94a3b8"/><rect x="9" y="15" width="6" height="4" rx="1" fill="#0f172a"/><circle cx="10" cy="7" r="1.5" fill="white"/><circle cx="14" cy="7" r="1.5" fill="white"/></svg>' }, { id: 'bot2', svg: '<svg width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="14" height="14" rx="7" class="avatar-colorable" fill="#f472b6" /><rect x="4" y="11" width="16" height="8" rx="4" fill="#94a3b8" /><rect x="8" y="8" width="8" height="5" rx="2.5" fill="#1e293b" /><path d="M9 10.5H15" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M4 16L2 19M20 16L22 19" stroke="#94a3b8" stroke-width="2" stroke-linecap="round" /></svg>' }, { id: 'bot3', svg: '<svg width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z" class="avatar-colorable" fill="#818cf8"/><path d="M12 16C14.2091 16 16 14.2091 16 12H8C8 14.2091 9.79086 16 12 16Z" fill="#1e293b" /><path d="M9.5 10C10.3284 10 11 9.32843 11 8.5C11 7.67157 10.3284 7 9.5 7C8.67157 7 8 7.67157 8 8.5C8 9.32843 8.67157 10 9.5 10Z" fill="white" /><path d="M14.5 10C15.3284 10 16 9.32843 16 8.5C16 7.67157 15.3284 7 14.5 7C13.6716 7 13 7.67157 13 8.5C13 9.32843 13.6716 10 14.5 10Z" fill="white" /><path d="M18 5L20 3M6 5L4 3" stroke="#818cf8" stroke-width="2" stroke-linecap="round" /></svg>' }, { id: 'bot4', svg: '<svg width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="8" width="16" height="12" rx="2" class="avatar-colorable" fill="#22c55e" /><path d="M8 8V6C8 3.79086 9.79086 2 12 2C14.2091 2 16 3.79086 16 6V8" fill="#94a3b8" /><circle cx="12" cy="14" r="3" fill="#1e293b" /><path d="M12 12.5V15.5" stroke="white" stroke-width="1.5" stroke-linecap="round" /></svg>' } ];
        const modules = [ 
            { id: 'passwords', title: 'Password Power-Up', badgeName: 'Password Protector', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 12h.01M12 6v2M12 16v2M18 12h-2M8 12H6M16.24 7.76l-1.41-1.41M9.17 14.83l-1.41-1.41M16.24 16.24l-1.41 1.41M9.17 9.17l-1.41 1.41"></path><circle cx="12" cy="12" r="10"></circle></svg>`, badgeIcon: `<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M12 8v4l2 1"></path></svg>`, gameType: 'passwordChecker', timeLimit: 90, introStory: "The city's main Gate is sealed by three power locks. To open the path, you must design a unique, super-strong password for each one. Think you've got the skills?", outroStory: "Bleep-bloop-BZZT! All locks are green! You crafted some seriously strong passwords and the main gate is open. You're a natural-born code cracker!", takeaways: ["Use a mix of uppercase, lowercase, numbers, and symbols.", "Longer passwords are stronger passwords.", "Never use personal information like your name or birthday."], content: [ { scenario: "The first lock protects the city's Park Wi-Fi. It needs to be simple but safe. It must be at least 8 characters and include a number.", rules: { minLength: 8, needsNumber: true, needsSymbol: false, needsUpper: false, needsLower: true } }, { scenario: "The second lock is on the Arcade's server. To protect the high scores, it needs a password of 10+ characters, an uppercase letter, and a symbol.", rules: { minLength: 10, needsNumber: true, needsSymbol: true, needsUpper: true, needsLower: true } }, { scenario: "The final lock protects Cybie's secret jetpack controls! It needs the strongest password of all: 12 characters with lowercase, uppercase, numbers, AND symbols.", rules: { minLength: 12, needsNumber: true, needsSymbol: true, needsUpper: true, needsLower: true } } ], heroContent: [ { scenario: "HERO MODE: The bank vault's laser grid needs a 14-character password with everything.", rules: { minLength: 14, needsNumber: true, needsSymbol: true, needsUpper: true, needsLower: true } }, { scenario: "HERO MODE: Secure the satellite uplink. It needs a 16-character password with at least two symbols and two numbers.", rules: { minLength: 16, needsNumber: true, needsSymbol: true, needsUpper: true, needsLower: true } } ] }, 
            { id: 'phishing', title: 'Phishing Trap Spotter', badgeName: 'Phish Finder', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path><line x1="12" y1="12" x2="12" y2="12.01"></line><line x1="12" y1="8" x2="12" y2="8.01"></line><line x1="12" y1="16" x2="12" y2="16.01"></line></svg>`, badgeIcon: `<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`, gameType: 'spotThePhish', timeLimit: 120, introStory: "Beep boop! Cybie alerts you: 'I've intercepted some suspicious messages. They might be phishing traps! It's up to you to inspect them and find all the red flags.'", outroStory: "Phew, that was a close one! You spotted all the tricks the phishers tried to use. Thanks to you, no one's data will be stolen today. You've earned your Phish Finder badge!", takeaways: ["Check the sender's email address for mistakes.", "Beware of messages that create panic or urgency.", "Don't click suspicious links, even if they look real."], content: [ { title: "Bank Alert Email", hotspots: [ { style: "top: 10%; left: 10%; width: 65%; height: 10%;", explanation: "That's not a real email address! Scammers often use weird addresses like 'your-bank-online.co' instead of '.com' to trick you." }, { style: "top: 28%; left: 10%; width: 80%; height: 10%;", explanation: "Big red flag! Real companies don't use scary threats to make you act fast. They want you to panic so you don't notice the other clues." }, { style: "top: 60%; left: 25%; width: 50%; height: 12%;", explanation: "A classic trick! The link looks okay, but it probably goes to a dangerous website. Never click links in emails you don't trust." }, { style: "top: 45%; left: 10%; width: 25%; height: 10%;", explanation: "Vague greetings like 'Dear Valued Customer' are suspicious. Your real bank would use your name!" } ] }, { title: "Package Delivery SMS", hotspots: [ { style: "top: 10%; left: 10%; width: 80%; height: 10%;", explanation: "Scammers often send texts from weird, unknown numbers." }, { style: "top: 25%; left: 10%; width: 80%; height: 35%;", explanation: "This message creates urgency and asks you to click a strange link. Real delivery companies use official tracking websites." }, { style: "top: 65%; left: 10%; width: 80%; height: 10%;", explanation: "Links shortened with services like 'bit.ly' can hide the real destination. Be extra careful with these!" } ] }, { title: "Social Media DM", hotspots: [ { style: "top: 10%; left: 25%; width: 65%; height: 10%;", explanation: "A message from a 'new' account of a friend is suspicious. Their real account might have been hacked. Verify with them another way!" }, { style: "top: 25%; left: 10%; width: 80%; height: 30%;", explanation: "Asking you to vote in a contest with a link is a common scam to steal your login information." }, { style: "top: 60%; left: 10%; width: 80%; height: 20%;", explanation: "Saying 'you can win something' is a way to get you excited and click without thinking. Always be skeptical of free prizes!" } ] } ], heroContent: [ { title: "HERO MODE: Tax Refund Notice", hotspots: [ { style: "top: 10%; left: 10%; width: 50%; height: 10%;", explanation: "Government agencies rarely email you out of the blue. This is very suspicious." }, { style: "top: 25%; left: 10%; width: 80%; height: 10%;", explanation: "'Urgent action required' is classic phishing language to make you rush." }, { style: "top: 40%; left: 10%; width: 80%; height: 20%;", explanation: "Asking for personal info like your Social Security Number in an email is a giant red flag." }, { style: "top: 65%; left: 20%; width: 60%; height: 15%;", explanation: "The link goes to 'gov-refunds.net' - not a real '.gov' website. Very tricky!" } ] } ] },
            { id: 'social', title: 'Social Media Smarts', badgeName: 'Social Sage', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><path d="M20 8v6M23 11h-6"></path></svg>`, badgeIcon: `<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`, gameType: 'dragAndDrop', timeLimit: 60, introStory: "This is the Cyber City Social Hub. A character named 'Pixel' is making a profile for the first time! Help them decide what's safe to share publicly and what should always be kept private. Drag each item to the correct zone!", outroStory: "You've mastered the art of social sharing! You helped Pixel create a fun AND safe profile. That's what being a true Social Sage is all about.", takeaways: ["Keep personal info like your name, address, and school private.", "It's okay to share hobbies and general interests.", "Think before you post: 'Would I be okay with a stranger seeing this?'"], content: [ { text: "A photo of your cat, Mittens", type: "safe" }, { text: "Your home address", type: "unsafe" }, { text: "Your high score in 'Jetpack Joyride'", type: "safe" }, { text: "A picture of your report card", type: "unsafe" }, { text: "A link to a funny YouTube video", type: "safe" }, { text: "Your parents' credit card number", type: "unsafe" }, { text: "Your phone number", type: "unsafe" }, { text: "A drawing you made", type: "safe" }, { text: "Your school's name", type: "unsafe" }, { text: "Your birthday (day and month only)", type: "safe"}, { text: "Your full name", "type": "unsafe"}, { text: "A cool nickname", "type": "safe" } ], heroContent: [ { text: "A photo of you in your school uniform", type: "unsafe"}, { text: "A post saying 'I'm bored at home alone'", type: "unsafe"}, { text: "A group photo where friends are tagged", type: "safe"}, { text: "Your email address", type: "unsafe"}, { text: "A review of a new movie", type: "safe"}, { text: "Your current location from GPS", type: "unsafe"} ] },
            { id: 'footprint', title: 'Digital Footprint Detective', badgeName: 'Footprint Finder', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-pink-500"><path d="M12 22c-5.523 0-10-4.477-10-10S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z"></path><path d="M12 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"></path><path d="M12 12v10"></path><path d="M12 12c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5z"></path></svg>`, badgeIcon: `<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>`, gameType: 'matchThePairs', timeLimit: 75, introStory: "Everywhere you go online, you leave a trace, like footprints in the sand. This is your digital footprint. Let's see if you can match the online action to the footprint it leaves behind!", outroStory: "Excellent! You understand that our actions online have consequences, both good and bad. By being careful, you can create a positive footprint that you can be proud of!", takeaways: ["Everything you do online creates your digital footprint.", "Your footprint can be positive or negative.", "Even deleted things can sometimes be found later."], content: [ { action: "Posting a kind comment", consequence: "Can make someone's day better" }, { action: "Sharing your password", consequence: "Someone could steal your account" }, { action: "Downloading a sketchy 'free' game", consequence: "Might put a virus on your computer" }, { action: "Liking a video about cats", consequence: "Tells the site to show you more cats" }, { action: "Googling 'how to bake a cake'", consequence: "Adds to your profile for advertisers" }, { action: "Using a friendly username", consequence: "Helps you make friends in games" }, { action: "Posting a photo from vacation", consequence: "Tells people you are not home" }, { action: "Deleting an embarrassing post", consequence: "Can still be saved by someone else" } ], heroContent: [ { action: "Using the same password everywhere", consequence: "If one site is hacked, all your accounts are at risk." }, { action: "Ignoring privacy settings", consequence: "Lets strangers see your posts and information." }, { action: "Sharing a 'funny' but mean meme", consequence: "Contributes to a negative online environment." }, { action: "Fact-checking a wild news story before sharing", consequence: "Helps stop the spread of misinformation." } ] }, 
            { id: 'cyberbullying', title: 'Cyberbullying Prevention', badgeName: 'Cyber Shield', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`, badgeIcon: `<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`, gameType: 'chooseYourResponse', timeLimit: 120, introStory: "Uh oh. We're detecting negative signals in the City's chat room. Someone is being unkind. Your mission is to choose the best response and be an UPSTANDER, not a bystander!", outroStory: "You did it! You earned your Cyber Shield by showing you know how to handle tough situations online with kindness and courage. You're a hero to everyone.", takeaways: ["Don't be a bystander; be an UPSTANDER.", "Use the 'Stop, Block, and Tell' method if you're targeted.", "Supporting someone who is being bullied is a heroic act."], content: [ { scenario: "In a group chat, one player starts making fun of another player's new avatar. What do you do?", options: [ { text: "Join in on the joke so they don't target you.", feedback: "It might feel safer, but joining in makes the problem worse. A true hero stands up for others!", correct: false }, { text: "Privately message the person being teased and say 'Hey, are you okay? That wasn't cool.'", feedback: "Excellent! You supported your friend without giving the bully more attention. That's a powerful first step.", correct: true }, { text: "Leave the group chat and never come back.", feedback: "While leaving is an option, it doesn't help the person being targeted. There are better ways to be an upstander.", correct: false } ] }, { scenario: "Someone sends you a mean message out of the blue. What's your first move?", options: [ { text: "Send a mean message back. An eye for an eye!", feedback: "Fighting back can make the situation worse and get you in trouble too. The strongest move is not to engage.", correct: false }, { text: "Don't reply, block the person, and tell a trusted adult.", feedback: "Perfect! This is the 'Stop, Block, and Tell' method, and it's the safest and most effective way to handle it.", correct: true }, { text: "Delete the message and try to forget it happened.", feedback: "It's important to tell an adult. Keeping it a secret can make you feel worse, and the person might do it to others.", correct: false } ] }, { scenario: "You see a friend share an embarrassing photo of someone else as a 'joke'. What's the move?", options: [ { text: "Like the photo and share it with your other friends.", feedback: "Even if it seems funny, sharing it adds to the embarrassment and is a form of bullying.", correct: false }, { text: "Comment 'This is mean, you should take it down.'", feedback: "Publicly calling them out might start a bigger fight. A private message is usually better.", correct: false }, { text: "Privately message your friend and explain that the photo could really hurt the other person's feelings.", feedback: "This is the best way. It educates your friend without shaming them and helps them see the impact of their actions.", correct: true } ] }, { scenario: "A player in an online game is cheating and calling everyone 'noobs'. What should you do?", options: [ { text: "Use the game's official 'Report Player' button and then mute them.", feedback: "Correct! This uses the game's safety tools to handle the problem without getting into a fight.", correct: true }, { text: "Start calling them names back.", feedback: "This just adds to the negativity. Don't sink to their level!", correct: false }, { text: "Quit the game and never play again.", feedback: "Don't let one bad apple ruin your fun! Using the report tools helps make the game better for everyone.", correct: false } ] } ], heroContent: [ { scenario: "HERO MODE: You receive a friend request from someone you don't know, but they have a lot of mutual friends. What's the safest move?", options: [ { text: "Accept it. If they know your friends, they must be okay.", feedback: "Not necessarily! Scammers create fake profiles to trick people. It's best to be cautious.", correct: false }, { text: "Ask one of your mutual friends who the person is before accepting.", feedback: "Smart move! Verifying with a trusted friend is a great way to stay safe from strangers.", correct: true }, { text: "Deny the request and block them immediately.", feedback: "This is a very safe option, but checking with a friend first is also a good, less extreme step.", correct: false } ] } ] } 
        ];
        const customizations = {
            colors: [
                { id: 'default', value: '#38bdf8', dark: '#0ea5e9', cost: 0 },
                { id: 'red', value: '#f87171', dark: '#ef4444', cost: 100 },
                { id: 'green', value: '#4ade80', dark: '#22c55e', cost: 100 },
                { id: 'purple', value: '#c084fc', dark: '#a855f7', cost: 100 },
                { id: 'yellow', value: '#facc15', dark: '#eab308', cost: 150 },
            ],
            accessories: [
                { id: 'none', svg: '', cost: 0 },
                { id: 'hat', svg: '<path d="M12 2L4 8h16L12 2z" fill="#334155" transform="translate(0, -2)"/>', cost: 200 },
                { id: 'glasses', svg: '<rect x="6" y="6" width="4" height="2" rx="1" fill="black"/><rect x="14" y="6" width="4" height="2" rx="1" fill="black"/><path d="M10 7h4" stroke="black" stroke-width="0.5"/>', cost: 250 }
            ]
        };

        // --- GAME STATE & FUNCTIONS ---
        let playerProfile = { username: null, avatarId: null, colorId: 'default', totalPoints: 0, completedModules: [], heroCompletedModules: [], stars: {}, badges: [], unlockedItems: ['default', 'none'], equipped: { color: 'default', accessory: 'none' }, dailyMission: { id: null, date: null } };
        let currentModule = null; let currentQuestionIndex = 0; let currentScore = 0; let isHeroMode = false;
        let phishingFoundCount = 0;
        let soundEnabled = true;
        let timerInterval = null;

        // --- SOUND ENGINE ---
        const sounds = {
            click: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination(),
            correct: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
            incorrect: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.1 } }).toDestination(),
            complete: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination(),
            purchase: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.8, release: 0.2 } }).toDestination(),
            timer: new Tone.MembraneSynth().toDestination(),
            fail: new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.1 } }).toDestination(),
        };
        const playSound = (sound, note, duration = '8n', time) => {
            if (!soundEnabled || !sounds[sound]) return;
            sounds[sound].triggerAttackRelease(note, duration, time);
        };
        const soundIcons = {
            on: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`,
            off: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`
        };
        const updateSoundButton = () => { 
            const icon = soundEnabled ? soundIcons.on : soundIcons.off;
            soundToggleBtn.innerHTML = icon;
            soundToggleBtnMobile.innerHTML = icon;
         };
        const toggleSound = () => { soundEnabled = !soundEnabled; updateSoundButton(); playSound('click', 'C4'); };

        const loadProfile = () => { 
            const savedProfile = localStorage.getItem('cyberGuardianProfile'); 
            if (savedProfile) { 
                playerProfile = JSON.parse(savedProfile); 
                if (!playerProfile.totalPoints) playerProfile.totalPoints = 0; 
                if(!playerProfile.unlockedItems) playerProfile.unlockedItems = ['default', 'none']; 
                if(!playerProfile.equipped) playerProfile.equipped = { color: 'default', accessory: 'none' };
                if(!playerProfile.heroCompletedModules) playerProfile.heroCompletedModules = [];
                if(!playerProfile.dailyMission) playerProfile.dailyMission = { id: null, date: null };
            } 
        };
        const saveProfile = () => { localStorage.setItem('cyberGuardianProfile', JSON.stringify(playerProfile)); };

        const init = () => {
            loadProfile();
            setDailyMission();
            
            showScreen('splash-screen');

            startJourneyBtn.addEventListener('click', () => { playSound('click', 'C4'); showScreen('login-screen'); usernameInput.focus(); });
            usernameInput.addEventListener('input', validateUsernameInput);
            validateUsernameInput(); 

            playBtn.addEventListener('click', () => { playSound('click', 'C4'); handleLogin(); });
            backToLoginBtn.addEventListener('click', () => { playSound('click', 'C4'); showScreen('login-screen'); });
            confirmAvatarBtn.addEventListener('click', () => { playSound('click', 'G4'); handleAvatarConfirm(); });
            backToAvatarBtn.addEventListener('click', () => { playSound('click', 'C4'); showAvatarScreen(); });
            startAdventureBtn.addEventListener('click', () => { playSound('click', 'G4'); showDashboard(); });


            closeModalBtn.addEventListener('click', () => { playSound('click', 'C4'); closeModal(); });
            modalContainer.addEventListener('click', (e) => { if (e.target === modalContainer) { playSound('click', 'C4'); closeModal(); } });
            playAgainBtn.addEventListener('click', () => { playSound('click', 'G4'); localStorage.removeItem('cyberGuardianProfile'); location.reload(); });
            
            [soundToggleBtn, soundToggleBtnMobile].forEach(btn => btn.addEventListener('click', toggleSound));
            [hqBtn, hqBtnMobile].forEach(btn => btn.addEventListener('click', () => { playSound('click', 'E4'); openGuardianHQ(); }));
            [handbookBtn, handbookBtnMobile].forEach(btn => btn.addEventListener('click', () => { playSound('click', 'E4'); openHandbook(); }));
            [storyBtn, storyBtnMobile].forEach(btn => btn.addEventListener('click', () => { playSound('click', 'E4'); openStoryHub(); }));
            
            const resetFn = () => {
                playSound('fail', 'C3');
                openConfirmationModal("Are you sure you want to reset all your progress? This can't be undone!", () => {
                    localStorage.removeItem('cyberGuardianProfile');
                    location.reload();
                });
            };
            resetBtn.addEventListener('click', resetFn);
            resetBtnMobile.addEventListener('click', resetFn);

            // Add scroll buttons for adventure path
            if (adventurePathWrapper) {
                const scrollLeft = () => { playSound('click', 'C3', '16n'); adventurePathContainer.scrollBy({ left: -250, behavior: 'smooth' }); };
                const scrollRight = () => { playSound('click', 'D3', '16n'); adventurePathContainer.scrollBy({ left: 250, behavior: 'smooth' }); };
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '&#9664;';
                prevBtn.className = 'absolute top-1/2 -translate-y-1/2 left-2 z-10 p-2 rounded-full bg-slate-700/50 hover:bg-slate-600/50 hidden lg:block';
                prevBtn.onclick = scrollLeft;
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = '&#9654;';
                nextBtn.className = 'absolute top-1/2 -translate-y-1/2 right-2 z-10 p-2 rounded-full bg-slate-700/50 hover:bg-slate-600/50 hidden lg:block';
                nextBtn.onclick = scrollRight;
                adventurePathWrapper.prepend(prevBtn);
                adventurePathWrapper.append(nextBtn);
            }

            // Mobile sidebar logic
            menuBtnMobile.addEventListener('click', () => {
                sidebarBackdrop.classList.remove('pointer-events-none', 'opacity-0');
                mobileSidebar.classList.add('open');
            });
            const closeSidebar = () => {
                sidebarBackdrop.classList.add('pointer-events-none', 'opacity-0');
                mobileSidebar.classList.remove('open');
            };
            sidebarBackdrop.addEventListener('click', closeSidebar);
            [hqBtnMobile, handbookBtnMobile, soundToggleBtnMobile, resetBtnMobile, storyBtnMobile].forEach(btn => btn.addEventListener('click', closeSidebar));

            updateSoundButton();
        };
        
        const validateUsernameInput = () => {
            playBtn.disabled = usernameInput.value.trim().length === 0;
        };

        const handleLogin = () => { const username = usernameInput.value.trim(); if (username) { playerProfile.username = username; showAvatarScreen(); } };
        
        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.remove('hidden', 'absolute');
                screen.classList.add('flex');
            }
        }
        
        const showAvatarScreen = () => { 
            showScreen('avatar-screen');
            avatarGrid.innerHTML = ''; 
            avatars.forEach(avatar => { 
                const el = document.createElement('div'); 
                el.className = 'avatar-option bg-slate-800/50 rounded-full p-2'; 
                el.innerHTML = avatar.svg; 
                el.dataset.avatarId = avatar.id; 
                el.addEventListener('click', () => { playSound('click', 'E4'); handleAvatarSelect(avatar.id); }); 
                avatarGrid.appendChild(el); 
            }); 
            colorGrid.innerHTML = '';
            customizations.colors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch w-12 h-12 rounded-full';
                swatch.style.backgroundColor = color.value || '#38bdf8';
                swatch.dataset.colorId = color.id;
                swatch.addEventListener('click', () => { playSound('click', 'F4'); handleColorSelect(color.id); });
                colorGrid.appendChild(swatch);
            });
            playerProfile.avatarId = null;
            playerProfile.colorId = 'default';
            handleColorSelect('default');
            validateAvatarAndColor();
        };

        const handleAvatarSelect = (avatarId) => { 
            playerProfile.avatarId = avatarId; 
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.toggle('selected', el.dataset.avatarId === avatarId)); 
            validateAvatarAndColor();
        };
        const handleColorSelect = (colorId) => {
            playerProfile.colorId = colorId;
            document.querySelectorAll('.color-swatch').forEach(el => el.classList.toggle('selected', el.dataset.colorId === colorId));
            const colorData = customizations.colors.find(c => c.id === colorId);
            document.documentElement.style.setProperty('--accent-color', colorData.value);
            document.documentElement.style.setProperty('--accent-color-dark', colorData.dark);
            validateAvatarAndColor();
        };
        const validateAvatarAndColor = () => {
            confirmAvatarBtn.disabled = !(playerProfile.avatarId && playerProfile.colorId);
        };

        const handleAvatarConfirm = () => { saveProfile(); showWelcome(); };
        const showWelcome = () => { 
            welcomeAvatar.innerHTML = getCustomizedAvatar(playerProfile.avatarId, playerProfile.equipped, '100'); 
            welcomeUsername.textContent = playerProfile.username; 
            welcomeUsername.style.color = 'var(--accent-color)';
            showScreen('welcome-screen'); 
        };
        
        const showDashboard = () => {
            showScreen('dashboard');
             dashboard.classList.remove('lg:grid');
             dashboard.classList.add('lg:grid'); // re-trigger display for some browsers
             renderDashboard();
        };

        const setDailyMission = () => {
            const today = new Date().toISOString().slice(0, 10);
            if (playerProfile.dailyMission.date !== today) {
                const completed = modules.filter(m => playerProfile.completedModules.includes(m.id));
                if (completed.length > 0) {
                    const randomMission = completed[Math.floor(Math.random() * completed.length)];
                    playerProfile.dailyMission = { id: randomMission.id, date: today };
                    saveProfile();
                }
            }
        };
        
        const renderDashboard = () => {
            updateStatsBar();
            adventurePathContainer.innerHTML = '';
            modules.forEach((module, index) => {
                const isCompleted = playerProfile.completedModules.includes(module.id);
                const isHeroCompleted = playerProfile.heroCompletedModules.includes(module.id);
                
                const isActive = !isCompleted;
                const isDaily = playerProfile.dailyMission.id === module.id;

                const node = document.createElement('div');
                
                let nodeClasses = 'path-node cursor-pointer';
               
                if (isCompleted) nodeClasses += ' completed';
                if (isActive) nodeClasses += ' active';
                if (isHeroCompleted) nodeClasses += ' hero-completed';
                if (isDaily) nodeClasses += ' daily-mission';
                node.className = nodeClasses;
                
                node.innerHTML = `<div class="path-node-building w-48 h-auto flex flex-col items-center">${module.icon}</div>`;
                node.addEventListener('click', () => { playSound('click', 'D4'); openModule(module.id); });
                adventurePathContainer.appendChild(node);
            });
        };

        const animateCounter = (el, start, end, duration) => {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                el.innerText = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        };
        
        const updateStatsBar = () => { 
            statsBar.avatar.innerHTML = getCustomizedAvatar(playerProfile.avatarId, playerProfile.equipped, '40');
            statsBar.username.textContent = playerProfile.username; 
            statsBar.points.textContent = playerProfile.totalPoints;
            statsBar.badges.textContent = `${playerProfile.badges.length}/${modules.length}`; 
            const progressPercent = (playerProfile.completedModules.length / modules.length) * 100; 
            statsBar.progress.style.width = `${progressPercent}%`; 
        };
        
        const openModal = (title, content, icon, headerClass = 'modal-header-default') => { 
            modalTitle.textContent = title; 
            modalBody.innerHTML = content; 
            modalHeaderIcon.innerHTML = icon || ''; 
            modalHeader.className = `p-5 border-b border-slate-700 flex justify-between items-center rounded-t-2xl ${headerClass}`;
            modalContainer.classList.remove('hidden'); 
            modalContent.classList.remove('modal-exit'); 
            modalContent.classList.add('modal-enter'); 
        };
        const openModule = (moduleId) => { 
            currentModule = modules.find(m => m.id === moduleId); 
            isHeroMode = false;
            if (playerProfile.completedModules.includes(moduleId)) {
                // Show mode select
                const content = `
                    <div class="text-center">
                        <h3 class="text-xl font-bold mb-4">You've completed this mission!</h3>
                        <p class="text-slate-300 mb-6">Replay for practice, or try a harder challenge in Hero Mode for more points!</p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button id="replay-standard-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg">Replay Standard</button>
                            <button id="start-hero-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg">Start Hero Mode (+75 pts)</button>
                        </div>
                    </div>`;
                openModal(currentModule.title, content, currentModule.icon, `modal-header-${currentModule.id}`);
                document.getElementById('replay-standard-btn').addEventListener('click', () => { playSound('click', 'G4'); startChallenge(false); });
                document.getElementById('start-hero-btn').addEventListener('click', () => { playSound('click', 'A4'); startChallenge(true); });
            } else {
                // First time playing
                startChallenge(false);
            }
        };
        const startChallenge = (isHero) => { 
            isHeroMode = isHero;
            currentQuestionIndex = 0; 
            currentScore = 0; 
            const story = `<div class="text-center text-slate-300"><p class="text-lg">${currentModule.introStory}</p><button id="start-challenge-btn" class="mt-8 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full text-lg transition duration-300 transform hover:scale-105 btn-press">${isHeroMode ? 'Start Timed Challenge!' : 'Start Challenge'}</button></div>`; 
            openModal(currentModule.title, story, currentModule.icon, `modal-header-${currentModule.id}`); 
            document.getElementById('start-challenge-btn').addEventListener('click', () => { playSound('click', 'G4'); 
                const content = isHeroMode ? currentModule.heroContent : currentModule.content;
                const gameType = currentModule.gameType;
                if(isHeroMode) startTimer(currentModule.timeLimit);
                if (gameType === 'quiz') renderQuizQuestion(content); 
                else if (gameType === 'passwordChecker') renderPasswordChecker(content); 
                else if (gameType === 'dragAndDrop') renderDragAndDrop(content); 
                else if (gameType === 'spotThePhish') renderSpotThePhish(content); 
                else if (gameType === 'matchThePairs') renderMatchThePairs(content); 
                else if (gameType === 'chooseYourResponse') renderChooseYourResponse(content); 
            }); 
        };

        const startTimer = (duration) => {
            let timeLeft = duration;
            timerDisplay.classList.remove('hidden');
            const updateTimer = () => {
                const minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                timerDisplay.textContent = `${minutes}:${seconds}`;

                if (timeLeft <= 10 && !timerDisplay.classList.contains('timer')) {
                    timerDisplay.classList.add('timer');
                    playSound('timer', 'C4', '16n');
                }

                if (timeLeft > 0) {
                    timeLeft--;
                } else {
                    clearInterval(timerInterval);
                    failMission("Time's up!");
                }
            };
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        };
        const stopTimer = () => {
             clearInterval(timerInterval);
             timerDisplay.classList.add('hidden');
             timerDisplay.classList.remove('timer');
        };

        const closeModal = () => { 
            stopTimer();
            modalContent.classList.remove('modal-enter'); 
            modalContent.classList.add('modal-exit'); 
            setTimeout(() => { modalContainer.classList.add('hidden'); }, 300); 
        };
        
        // --- GAME LOGIC PER TYPE (now accepts content as param) ---
        const renderQuizQuestion = (content) => { const q = content[currentQuestionIndex]; const c = `<h4 class="text-xl text-slate-200 mb-6 text-center">${q.question}</h4><div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">${q.options.map((o, i) => `<button class="option-btn text-left p-4 bg-slate-700 rounded-lg border-2 border-slate-600 hover:bg-slate-600 hover:border-sky-500 transition" data-index="${i}">${o}</button>`).join('')}</div><div id="feedback" class="mt-6 text-center p-4 rounded-lg bg-slate-700 hidden"></div>`; openModal(currentModule.title, c, currentModule.icon, `modal-header-${currentModule.id}`); document.querySelectorAll('.option-btn').forEach(b => b.addEventListener('click', (e) => { playSound('click', 'C4'); handleQuizAnswer(e, content); })); };
        const handleQuizAnswer = (e, content) => { const selectedIndex = parseInt(e.target.dataset.index); const q = content[currentQuestionIndex]; document.querySelectorAll('#options-container button').forEach(b => b.disabled = true); const feedback = document.getElementById('feedback'); if (selectedIndex === q.correctAnswer) { playSound('correct', 'G5'); currentScore++; e.target.classList.add('correct'); feedback.innerHTML = `<p class="font-bold text-green-400">Correct!</p><p class="mt-1 text-slate-300">${q.explanation}</p>`; } else { playSound('incorrect', 'C3'); e.target.classList.add('incorrect'); document.querySelector(`[data-index="${q.correctAnswer}"]`).classList.add('correct'); feedback.innerHTML = `<p class="font-bold text-red-400">Not quite!</p><p class="mt-1 text-slate-300">${q.explanation}</p>`; } feedback.classList.remove('hidden'); setTimeout(() => { currentQuestionIndex++; if (currentQuestionIndex < content.length) renderQuizQuestion(content); else endMission(content.length); }, 4000); };
        const renderPasswordChecker = (content) => { const challenge = content[currentQuestionIndex]; let rulesHTML = '<ul>'; const rules = challenge.rules; if (rules.minLength) rulesHTML += `<li id="rule-length" class="text-red-400">At least ${rules.minLength} characters</li>`; if (rules.needsLower) rulesHTML += `<li id="rule-lower" class="text-red-400">A lowercase letter (a-z)</li>`; if (rules.needsUpper) rulesHTML += `<li id="rule-upper" class="text-red-400">An uppercase letter (A-Z)</li>`; if (rules.needsNumber) rulesHTML += `<li id="rule-number" class="text-red-400">A number (0-9)</li>`; if (rules.needsSymbol) rulesHTML += `<li id="rule-symbol" class="text-red-400">A symbol (!, @, #, $)</li>`; rulesHTML += '</ul>'; const c = `<h4 class="text-lg text-slate-200 mb-4 text-center">${challenge.scenario}</h4><div class="my-4 p-4 bg-slate-900 rounded-lg"><p class="font-semibold mb-2 text-sky-300">Requirements:</p>${rulesHTML}</div><input type="text" id="password-input" class="w-full p-3 bg-slate-700 border-2 border-slate-600 rounded-lg text-white" placeholder="Type your password here..."><div class="w-full bg-slate-600 rounded-full h-2.5 mt-4"><div id="password-strength-bar" style="width: 0%"></div></div><div class="text-center mt-6"><button id="submit-password-btn" class="bg-slate-600 text-white font-bold py-2 px-6 rounded-full transition duration-300" disabled>Submit</button></div>`; openModal(`${currentModule.title} (${currentQuestionIndex + 1}/${content.length})`, c, currentModule.icon, `modal-header-${currentModule.id}`); document.getElementById('password-input').addEventListener('input', (e) => checkPasswordStrength(e, content)); document.getElementById('submit-password-btn').addEventListener('click', () => { playSound('correct', 'G5'); handlePasswordSubmit(content); }); };
        const checkPasswordStrength = (e, content) => { const password = e.target.value; const rules = content[currentQuestionIndex].rules; const submitBtn = document.getElementById('submit-password-btn'); const strengthBar = document.getElementById('password-strength-bar'); let strength = 0; let allRulesMet = true; const check = (ruleId, condition) => { const el = document.getElementById(ruleId); if (!el) return; if(condition) { el.classList.remove('text-red-400'); el.classList.add('text-green-400'); strength++; } else { el.classList.add('text-red-400'); el.classList.remove('text-green-400'); allRulesMet = false; } }; check('rule-length', password.length >= rules.minLength); check('rule-lower', rules.needsLower ? /[a-z]/.test(password) : true); check('rule-upper', rules.needsUpper ? /[A-Z]/.test(password) : true); check('rule-number', rules.needsNumber ? /\d/.test(password) : true); check('rule-symbol', rules.needsSymbol ? /[!@#$%^&*]/.test(password) : true); const totalRules = Object.values(rules).filter(v => v).length; const strengthPercent = totalRules > 0 ? (strength / totalRules) * 100 : 0; strengthBar.style.width = `${strengthPercent}%`; if (strengthPercent < 40) strengthBar.style.backgroundColor = '#ef4444'; else if (strengthPercent < 80) strengthBar.style.backgroundColor = '#f59e0b'; else strengthBar.style.backgroundColor = '#22c55e'; submitBtn.disabled = !allRulesMet; };
        const handlePasswordSubmit = (content) => { currentScore++; currentQuestionIndex++; if (currentQuestionIndex < content.length) renderPasswordChecker(content); else endMission(content.length); };
        const renderDragAndDrop = (content) => { const items = content.map((item, i) => `<div id="drag-${i}" class="drag-item bg-slate-700 p-3 rounded-lg text-center" draggable="true" data-type="${item.type}">${item.text}</div>`).join(''); const c = `<div class="grid md:grid-cols-2 gap-4"><div class="flex flex-col gap-3" id="items-container">${items}</div><div class="flex flex-col gap-4"><div id="safe-zone" class="drop-zone bg-slate-900/50 rounded-lg p-4 border-2 border-dashed border-slate-600 flex-grow" data-type="safe"><h4 class="text-green-400 font-bold text-center mb-2">✅ Safe to Share</h4></div><div id="unsafe-zone" class="drop-zone bg-slate-900/50 rounded-lg p-4 border-2 border-dashed border-slate-600 flex-grow" data-type="unsafe"><h4 class="text-red-400 font-bold text-center mb-2">❌ Not Safe to Share</h4></div></div></div>`; openModal(currentModule.title, c, currentModule.icon, `modal-header-${currentModule.id}`); document.querySelectorAll('.drag-item').forEach(item => item.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.target.id))); document.querySelectorAll('.drop-zone').forEach(zone => { zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('over'); }); zone.addEventListener('dragleave', e => zone.classList.remove('over')); zone.addEventListener('drop', (e) => handleDrop(e, content)); }); };
        const handleDrop = (e, content) => { e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); const item = document.getElementById(id); const zone = e.currentTarget; zone.classList.remove('over'); if (item.dataset.type === zone.dataset.type) { playSound('correct', 'E5'); zone.appendChild(item); item.classList.add('correct'); item.draggable = false; currentScore++; if (currentScore === content.length) { setTimeout(() => endMission(content.length), 500); } } else { playSound('incorrect', 'C3'); } };
        const renderSpotThePhish = (content) => { phishingFoundCount = 0; const challenge = content[currentQuestionIndex]; const hotspots = challenge.hotspots.map((h, i) => `<div class="phishing-drop-zone absolute border-2 border-dashed border-red-500/50 rounded" style="${h.style}" data-index="${i}"></div>`).join(''); let emailHTML = ''; if(challenge.title.includes("Bank")) { emailHTML = `<p><b>From:</b> <span class="text-blue-700">security-update@your-bank-online.co</span></p><p><b>Subject:</b> <span class="font-bold text-red-600">URGENT: Your Account will be DELETED!</span></p><hr class="my-2"><p>Dear Valued Customer,</p><p class="my-2">We detected suspicious activity on your account. To protect your funds, we have temporarily suspended your profile. You must verify your identity within 24 hours or your account will be permanently deleted.</p><p class="my-4 text-center"><a href="#" class="bg-blue-600 text-white font-bold py-2 px-4 rounded" onclick="event.preventDefault()">Click Here To Verify Now</a></p><p>Thank you,<br>Your Bank Security Team</p>`; } else if (challenge.title.includes("Package")) { emailHTML = `<p><b>From:</b> <span class="text-blue-700">+1-555-123-4567</span></p><p><b>Subject:</b> <span class="font-bold">Your Package Delivery</span></p><hr class="my-2"><p>FedExpress: We were unable to deliver your package today. The address on file may be incorrect. Please confirm your details immediately to schedule a new delivery.</p><p class="my-4 text-center">Follow this link: <a href="#" class="text-blue-600 underline" onclick="event.preventDefault()">bit.ly/track-now123</a></p>`; } else if (challenge.title.includes("Social")) { emailHTML = `<p><b>From:</b> <span class="text-blue-700">YourFriend22 (New Account)</span></p><p><b>Subject:</b> <span class="font-bold">OMG Check this out!</span></p><hr class="my-2"><p>Hey! It's me! I lost my old account, this is my new one. I'm in a contest to win a new gaming PC, can you vote for me please? You can win one too!</p><p class="my-4 text-center"><a href="#" class="text-blue-600 underline" onclick="event.preventDefault()">Click here to vote for me!</a></p>`; } else { emailHTML = `<p><b>From:</b> <span class="text-blue-700">official.tax.department@gov-refunds.net</span></p><p><b>Subject:</b> <span class="font-bold">Urgent action required: Your tax refund is waiting</span></p><hr class="my-2"><p>Dear Citizen,</p><p class="my-2">Our records indicate an error in your tax calculation. You are eligible for a refund of $500. To receive your funds, please provide your Social Security Number and bank details on our secure portal.</p><p class="my-4 text-center"><a href="#" class="bg-blue-600 text-white font-bold py-2 px-4 rounded" onclick="event.preventDefault()">Access Secure Portal</a></p>`; } const c = `<h4 class="text-lg text-slate-200 mb-2 text-center">${challenge.title}</h4><div class="text-center mb-4 text-slate-300">Click on all suspicious parts! <span id="phish-counter" class="font-bold text-lg text-amber-400">0/${challenge.hotspots.length}</span> found.</div><div class="bg-white text-black p-4 rounded-lg font-sans phish-email-body">${emailHTML}${hotspots}</div><div id="feedback" class="mt-4 text-center p-3 rounded-lg bg-slate-700 hidden"></div><div id="phish-navigation" class="text-center mt-4 hidden"><button id="next-phish-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full">Next</button></div>`; openModal(`${currentModule.title} (${currentQuestionIndex + 1}/${content.length})`, c, currentModule.icon, `modal-header-${currentModule.id}`); document.querySelectorAll('.phishing-drop-zone').forEach(h => h.addEventListener('click', (e) => handlePhishClick(e, content))); };
        const handlePhishClick = (e, content) => { const el = e.target; if (el.classList.contains('found')) return; playSound('correct', 'A5'); el.classList.add('found'); phishingFoundCount++; const challenge = content[currentQuestionIndex]; document.getElementById('phish-counter').textContent = `${phishingFoundCount}/${challenge.hotspots.length}`; const feedback = document.getElementById('feedback'); feedback.classList.remove('hidden'); feedback.innerHTML = `<p class="font-bold text-green-400">Good find!</p><p class="text-slate-300">${challenge.hotspots[el.dataset.index].explanation}</p>`; if (phishingFoundCount === challenge.hotspots.length) { currentScore++; const nav = document.getElementById('phish-navigation'); nav.classList.remove('hidden'); const nextBtn = document.getElementById('next-phish-btn'); if (currentQuestionIndex < content.length - 1) { nextBtn.textContent = 'Next Email'; nextBtn.onclick = () => { playSound('click', 'G4'); currentQuestionIndex++; renderSpotThePhish(content); }; } else { nextBtn.textContent = 'Finish Mission'; nextBtn.onclick = () => { playSound('click', 'G4'); endMission(content.length); } } } };
        const renderMatchThePairs = (content) => { const contentData = content; const actions = contentData.map((item, i) => `<div class="match-item p-3 bg-slate-700 rounded-lg border-2 border-slate-600" data-type="action" data-pair="${i}">${item.action}</div>`).join(''); const consequences = [...contentData].sort(() => Math.random() - 0.5).map((item, i) => `<div class="match-item p-3 bg-slate-700 rounded-lg border-2 border-slate-600" data-type="consequence" data-pair="${contentData.findIndex(c => c.consequence === item.consequence)}">${item.consequence}</div>`).join(''); const c = `<div class="text-center mb-4 text-slate-300">Click an action on the left, then click its matching consequence on the right!</div><div id="hint-container" class="text-center mb-4"><button id="hint-btn" class="text-sky-400 text-sm hover:underline">Need a hint?</button></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div class="flex flex-col gap-3">${actions}</div><div class="flex flex-col gap-3">${consequences}</div></div>`; openModal(currentModule.title, c, currentModule.icon, `modal-header-${currentModule.id}`); let selectedAction = null; document.querySelectorAll('.match-item').forEach(item => { item.addEventListener('click', (e) => { playSound('click', 'C4'); const target = e.currentTarget; if (target.classList.contains('matched')) return; if (target.dataset.type === 'action') { if (selectedAction) selectedAction.classList.remove('selected'); selectedAction = target; selectedAction.classList.add('selected'); } else if (target.dataset.type === 'consequence' && selectedAction) { if (selectedAction.dataset.pair === target.dataset.pair) { playSound('correct', 'F5'); selectedAction.classList.add('matched'); target.classList.add('matched'); selectedAction.classList.remove('selected'); selectedAction = null; currentScore++; if (currentScore === contentData.length) { setTimeout(() => endMission(contentData.length), 500); } } else { playSound('incorrect', 'C3'); selectedAction.classList.remove('selected'); selectedAction = null; } } }); }); document.getElementById('hint-btn').addEventListener('click', giveMatchHint); };
        const giveMatchHint = () => { playSound('click', 'E4'); const firstUnmatchedAction = document.querySelector('.match-item[data-type="action"]:not(.matched)'); if (firstUnmatchedAction) { const pairId = firstUnmatchedAction.dataset.pair; const matchingConsequence = document.querySelector(`.match-item[data-type="consequence"][data-pair="${pairId}"]`); firstUnmatchedAction.classList.add('hint'); matchingConsequence.classList.add('hint'); document.getElementById('hint-btn').disabled = true; setTimeout(() => { firstUnmatchedAction.classList.remove('hint'); matchingConsequence.classList.remove('hint'); }, 2000); } };
        const renderChooseYourResponse = (content) => { const q = content[currentQuestionIndex]; const c = `<h4 class="text-xl text-slate-200 mb-6 text-center">${q.scenario}</h4><div id="options-container" class="flex flex-col gap-4">${q.options.map((o, i) => `<button class="option-btn text-left p-4 bg-slate-700 rounded-lg border-2 border-slate-600 hover:bg-slate-600 hover:border-sky-500 transition" data-index="${i}">${o.text}</button>`).join('')}</div><div id="feedback" class="mt-6 text-center p-4 rounded-lg bg-slate-700 hidden"></div>`; openModal(`${currentModule.title} (${currentQuestionIndex + 1}/${content.length})`, c, currentModule.icon, `modal-header-${currentModule.id}`); document.querySelectorAll('.option-btn').forEach(b => b.addEventListener('click', (e) => handleResponseAnswer(e, content))); };
        const handleResponseAnswer = (e, content) => { const index = parseInt(e.target.dataset.index); const q = content[currentQuestionIndex]; const option = q.options[index]; document.querySelectorAll('#options-container button').forEach(b => b.disabled = true); const feedback = document.getElementById('feedback'); if (option.correct) { playSound('correct', 'G5'); currentScore++; e.target.classList.add('correct'); feedback.innerHTML = `<p class="font-bold text-green-400">Great choice!</p><p class="mt-1 text-slate-300">${option.feedback}</p>`; } else { playSound('incorrect', 'C3'); e.target.classList.add('incorrect'); document.querySelector(`[data-index="${content[currentQuestionIndex].options.findIndex(o => o.correct)}"]`).classList.add('correct'); feedback.innerHTML = `<p class="font-bold text-red-400">Think again...</p><p class="mt-1 text-slate-300">${option.feedback}</p>`; } feedback.classList.remove('hidden'); setTimeout(() => { currentQuestionIndex++; if (currentQuestionIndex < content.length) renderChooseYourResponse(content); else endMission(content.length); }, 5000); };
        
        const failMission = (reason) => {
            stopTimer();
            playSound('fail', 'C3', '2n');
            const content = `<div class="text-center"><h2 class="text-3xl font-bold mt-4 text-red-500">Mission Failed!</h2><p class="text-slate-300 mt-4">${reason}</p><p class="mt-2">Don't worry, you can try again!</p><button id="retry-btn" class="mt-8 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full">Retry Mission</button></div>`;
            openModal("Challenge Failed", content, currentModule.icon, `modal-header-${currentModule.id}`);
            document.getElementById('retry-btn').addEventListener('click', () => {
                closeModal();
                openModule(currentModule.id);
            });
        };

        const endMission = (totalQuestions) => {
            stopTimer();
            const percentage = totalQuestions > 0 ? (currentScore / totalQuestions) : 1;
            let stars = 0;
            if (percentage >= 1) stars = 3;
            else if (percentage >= 0.5) stars = 2;
            else if (currentScore > 0) stars = 1;

            let pointsEarned = 0;
            const isDaily = playerProfile.dailyMission.id === currentModule.id;
            
            if (isHeroMode) {
                if (stars === 3 && !playerProfile.heroCompletedModules.includes(currentModule.id)) {
                    pointsEarned = 75;
                    playerProfile.heroCompletedModules.push(currentModule.id);
                } else if (stars === 3) {
                    pointsEarned = 15; // Replay hero bonus
                }
            } else {
                 if (!playerProfile.completedModules.includes(currentModule.id)) {
                    pointsEarned = stars === 3 ? 50 : (stars === 2 ? 25 : (stars === 1 ? 10 : 0));
                    if (isDaily) pointsEarned += 25; // Daily Bonus
                }
            }
            
            if (pointsEarned > 0) {
                const pointsEl = document.createElement('div');
                pointsEl.className = 'points-animation';
                pointsEl.textContent = `+${pointsEarned}`;
                app.appendChild(pointsEl);
                setTimeout(() => pointsEl.remove(), 1500);
            }

            playerProfile.totalPoints += pointsEarned;
            if (!playerProfile.completedModules.includes(currentModule.id)) playerProfile.completedModules.push(currentModule.id);
            if(stars > (playerProfile.stars[currentModule.id] || 0) && !isHeroMode) playerProfile.stars[currentModule.id] = stars;
            if (!playerProfile.badges.includes(currentModule.id)) playerProfile.badges.push(currentModule.id);
            saveProfile();
            
            const now = Tone.now();
            playSound('complete', 'G5', '16n', now); 
            playSound('complete', 'C6', '16n', now + 0.1);

            let starsHTML = '<div class="flex justify-center my-4">';
            for(let i = 1; i <= 3; i++) { starsHTML += `<svg class="w-10 h-10 star ${i <= stars ? 'filled' : ''}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>`; }
            starsHTML += '</div>';

            const takeawaysHTML = currentModule.takeaways ? `<div class="mt-6 p-4 bg-slate-900/50 rounded-lg text-left"><h4 class="font-bold text-sky-300 mb-2">Key Takeaways:</h4><ul class="list-disc list-inside text-slate-300">${currentModule.takeaways.map(t => `<li>${t}</li>`).join('')}</ul></div>` : '';

            const content = `
                <div class="text-center">
                    <h2 class="text-3xl font-bold mt-4 text-white">Mission Complete!</h2>
                    ${starsHTML}
                    <p class="text-2xl font-bold text-sky-400">${pointsEarned > 0 ? `+${pointsEarned} Points!` : 'Great review!'}</p>
                    <p class="text-slate-300 mt-2">${currentModule.outroStory}</p>
                    <h3 class="text-xl font-bold mt-6 text-amber-400">${playerProfile.badges.includes(currentModule.id) ? 'Badge Reminder' : 'Badge Unlocked!'}</h3>
                    <div class="flex flex-col items-center mt-2">
                        <div class="text-amber-400">${currentModule.badgeIcon}</div>
                        <p class="font-semibold text-white">${currentModule.badgeName}</p>
                    </div>
                    ${takeawaysHTML}
                    <button id="continue-btn" class="mt-8 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full">Continue</button>
                </div>`;
            openModal("Mission Accomplished", content, currentModule.icon, `modal-header-${currentModule.id}`);
            
            document.getElementById('continue-btn').addEventListener('click', () => {
                playSound('click', 'G4');
                closeModal();
                if (playerProfile.completedModules.length === modules.length) {
                    showCertificate();
                } else {
                    renderDashboard();
                }
            });
            updateStatsBar();
        };

        const showCertificate = () => {
            closeModal();
            dashboard.classList.add('hidden');
            certificateAvatar.innerHTML = getCustomizedAvatar(playerProfile.avatarId, playerProfile.equipped, '100');
            certificateUsername.textContent = playerProfile.username;
            certificateBadges.innerHTML = '';
            playerProfile.badges.forEach(moduleId => {
                const module = modules.find(m => m.id === moduleId);
                const badgeEl = document.createElement('div');
                badgeEl.className = 'text-amber-400';
                badgeEl.innerHTML = module.badgeIcon.replace(/width="64"/g, 'width="48"').replace(/height="64"/g, 'height="48"');
                certificateBadges.appendChild(badgeEl);
            });
            certificateScreen.classList.remove('hidden');
            certificateScreen.classList.add('flex');
            const now = Tone.now();
            playSound('complete', 'C5', '8n', now); 
            playSound('complete', 'E5', '8n', now + 0.1); 
            playSound('complete', 'G5', '8n', now + 0.2); 
            playSound('complete', 'C6', '4n', now + 0.3);
        };

        const getCustomizedAvatar = (avatarId, equipped, size) => {
            const avatarData = avatars.find(a => a.id === avatarId);
            if (!avatarData) return '';
            
            let svg = avatarData.svg.replace(/width="100"/g, `width="${size}"`).replace(/height="100"/g, `height="${size}"`);
            
            const colorData = customizations.colors.find(c => c.id === equipped.color);
            if (colorData && colorData.value) {
                svg = svg.replace(/class="avatar-colorable" fill="[^"]*"/, `class="avatar-colorable" fill="${colorData.value}"`);
            }
            
            const accessoryData = customizations.accessories.find(a => a.id === equipped.accessory);
            if (accessoryData && accessoryData.svg) {
                svg = svg.replace('</svg>', `${accessoryData.svg}</svg>`);
            }
            
            return svg;
        };
        
        const openConfirmationModal = (message, onConfirm) => {
            const content = `
                <div class="text-center">
                    <p class="text-lg text-slate-300 mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-cancel" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                        <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirm</button>
                    </div>
                </div>`;
            openModal("Are you sure?", content, '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>');
            document.getElementById('confirm-cancel').addEventListener('click', () => { playSound('click', 'C4'); closeModal(); });
            document.getElementById('confirm-ok').addEventListener('click', () => { playSound('fail', 'C3'); onConfirm(); closeModal(); });
        };

        const openGuardianHQ = () => {
            const colorsHTML = customizations.colors.map(color => {
                const isUnlocked = playerProfile.unlockedItems.includes(color.id);
                const isEquipped = playerProfile.equipped.color === color.id;
                return `
                    <div class="customization-item text-center cursor-pointer" data-item-id="${color.id}" data-item-type="color" data-cost="${color.cost}">
                        <div class="w-12 h-12 rounded-full border-4 border-slate-600 ${isEquipped ? 'selected' : ''}" style="background-color: ${color.value || '#ccc'};"></div>
                        <p class="text-sm mt-1">${isUnlocked ? 'Owned' : `${color.cost} pts`}</p>
                    </div>
                `;
            }).join('');
            
            const accessoriesHTML = customizations.accessories.map(acc => {
                const isUnlocked = playerProfile.unlockedItems.includes(acc.id);
                const isEquipped = playerProfile.equipped.accessory === acc.id;
                return `
                     <div class="customization-item text-center cursor-pointer border-4 border-slate-600 rounded-lg p-2 ${isEquipped ? 'selected' : ''}" data-item-id="${acc.id}" data-item-type="accessory" data-cost="${acc.cost}">
                        <div class="w-12 h-12 flex items-center justify-center text-2xl font-bold">${acc.id === 'none' ? '∅' : acc.id === 'hat' ? '🎩' : '🕶️'}</div>
                        <p class="text-sm mt-1">${isUnlocked ? 'Owned' : `${acc.cost} pts`}</p>
                    </div>
                `;
            }).join('');

            const content = `
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 flex flex-col items-center bg-slate-900/50 p-4 rounded-lg">
                        <h3 class="text-xl font-bold mb-4">Your Guardian</h3>
                        <div id="hq-avatar-preview">${getCustomizedAvatar(playerProfile.avatarId, playerProfile.equipped, '150')}</div>
                        <p class="mt-4 text-sky-400 font-bold text-lg">Points: ${playerProfile.totalPoints}</p>
                    </div>
                    <div class="md:col-span-2">
                        <div>
                            <h4 class="text-lg font-semibold mb-3 text-fuchsia-400">Colors</h4>
                            <div class="flex flex-wrap gap-4">${colorsHTML}</div>
                        </div>
                        <div class="mt-6">
                            <h4 class="text-lg font-semibold mb-3 text-fuchsia-400">Accessories</h4>
                            <div class="flex flex-wrap gap-4">${accessoriesHTML}</div>
                        </div>
                    </div>
                </div>
            `;
            openModal('Guardian HQ', content, '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>');

            document.querySelectorAll('.customization-item').forEach(item => {
                item.addEventListener('click', handleCustomizationClick);
            });
        };

        const handleCustomizationClick = (e) => {
            const itemEl = e.currentTarget;
            const { itemId, itemType, cost } = itemEl.dataset;

            if (playerProfile.unlockedItems.includes(itemId)) {
                // Equip item
                playSound('click', 'E4');
                playerProfile.equipped[itemType] = itemId;
            } else {
                // Try to purchase
                if (playerProfile.totalPoints >= parseInt(cost)) {
                    playSound('purchase', 'A5');
                    playerProfile.totalPoints -= parseInt(cost);
                    playerProfile.unlockedItems.push(itemId);
                    playerProfile.equipped[itemType] = itemId;
                    updateStatsBar(); // Update points display immediately
                } else {
                    playSound('incorrect', 'C3');
                    // Maybe show a "not enough points" message
                    return;
                }
            }
            saveProfile();
            openGuardianHQ(); // Re-render the HQ
            renderDashboard(); // Re-render dashboard to show new avatar
        };

        const openHandbook = () => {
             const unlockedEntries = modules.filter(m => playerProfile.completedModules.includes(m.id));
             let content;
             if (unlockedEntries.length === 0) {
                content = `<p class="text-center text-slate-400">Complete missions to unlock entries in your handbook!</p>`;
             } else {
                 content = unlockedEntries.map(module => `
                    <div class="mb-4 p-4 bg-slate-700/50 rounded-lg">
                        <h4 class="text-xl font-bold text-sky-300 flex items-center gap-2">${module.icon.replace(/width="\d+"/g, 'width="24"').replace(/height="\d+"/g, 'height="24"')} ${module.title}</h4>
                        <ul class="list-disc list-inside text-slate-300 mt-2 ml-2">
                            ${module.takeaways.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    </div>
                 `).join('');
             }
             openModal('Guardian Handbook', content, '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path fill="currentColor" d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>');
        };

        const openStoryHub = () => {
            // This is where you would list multiple stories. For now, we only have one.
            const isUnlocked = playerProfile.completedModules.length >= 2;
            const content = `
                <div class="flex flex-col gap-4">
                    <div class="p-4 rounded-lg ${isUnlocked ? 'bg-slate-700/50 cursor-pointer hover:bg-slate-700' : 'bg-slate-800/50 opacity-50'}">
                        <h4 class="text-xl font-bold text-amber-300">Case of the Glitch Bandit</h4>
                        <p class="text-slate-400 mt-1">${isUnlocked ? 'A strange glitch is causing chaos in Cyber City. Help Cybie investigate!' : 'Locked: Complete 2 missions to unlock.'}</p>
                    </div>
                </div>
            `;
            openModal('Story Missions', content, '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path fill="currentColor" d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>');
        };
        
        init();
    });
    </script>
</body>
</html>

